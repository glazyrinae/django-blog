FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    curl build-essential pkg-config git ninja-build meson python3 \
    libssl-dev libxml2-dev liblz4-dev libzstd-dev libyaml-dev libbz2-dev \
    libpq-dev zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

ARG APP_UID=1001
ARG APP_GID=1001

RUN groupadd -g ${APP_GID} pgbackresthost \
    && useradd -u ${APP_UID} -g ${APP_GID} -d /home/pgbackrest -s /bin/bash pgbackresthost \
    && mkdir -p /home/pgbackrest \
    && chown ${APP_UID}:${APP_GID} /home/pgbackrest


# сборка pgBackRest 2.57
WORKDIR /tmp

ARG PGBACKREST_VERSION=2.57.0

COPY pgbackrest-release-${PGBACKREST_VERSION}.tar.gz /tmp/pgbackrest.tar.gz

RUN tar -xf /tmp/pgbackrest.tar.gz -C /tmp \
    && cd /tmp/pgbackrest-release-${PGBACKREST_VERSION} \
    && meson setup build --prefix=/usr \
    && ninja -C build \
    && ninja -C build install \
    && cd / && rm -rf /tmp/pgbackrest*



ENTRYPOINT ["pgbackrest"]
