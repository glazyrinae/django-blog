FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    curl build-essential pkg-config git openssh-client openssh-server rsync gosu \
    ninja-build meson python3 \
    libssl-dev libxml2-dev liblz4-dev libzstd-dev libyaml-dev libbz2-dev \
    libpq-dev zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

ARG APP_UID=1001
ARG APP_GID=1001

RUN groupadd -g ${APP_GID} pgbackresthost \
    && useradd -u ${APP_UID} -g ${APP_GID} -d /home/pgbackrest -s /bin/bash pgbackresthost \
    && mkdir -p /home/pgbackrest \
    && chown ${APP_UID}:${APP_GID} /home/pgbackrest


# сборка pgBackRest из официального репозитория
WORKDIR /tmp

ARG PGBACKREST_GIT_REF=release/2.57

RUN git clone --depth 1 --branch ${PGBACKREST_GIT_REF} https://github.com/pgbackrest/pgbackrest.git /tmp/pgbackrest \
    && cd /tmp/pgbackrest \
    && meson setup build --prefix=/usr \
    && ninja -C build \
    && ninja -C build install \
    && cd / && rm -rf /tmp/pgbackrest*

# default SSH setup for runtime key mounts and daemon
RUN mkdir -p /home/pgbackrest/.ssh /var/run/sshd \
    && chown ${APP_UID}:${APP_GID} /home/pgbackrest/.ssh \
    && chmod 700 /home/pgbackrest/.ssh \
    && sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config \
    && echo 'PermitRootLogin no' >> /etc/ssh/sshd_config \
    && echo 'AllowUsers pgbackresthost' >> /etc/ssh/sshd_config \
    && echo 'AuthorizedKeysFile /home/pgbackrest/.ssh/authorized_keys' >> /etc/ssh/sshd_config

COPY entrypoint.sh /usr/local/bin/pgbackrest-entrypoint.sh
RUN chmod +x /usr/local/bin/pgbackrest-entrypoint.sh

ENTRYPOINT ["/usr/local/bin/pgbackrest-entrypoint.sh"]
