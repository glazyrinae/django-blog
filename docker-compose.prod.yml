services:
  web:
    command: gunicorn tiny_cms.wsgi:application -c /app/gunicorn.conf.py
    env_file:
      - ./.env.prod
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    volumes:
      - ./deploy/gunicorn.conf.py:/app/gunicorn.conf.py
    restart: unless-stopped
  
  nginx:
    build: ./nginx
    depends_on:
      - web
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./app/staticfiles:/var/www/static 
      - ./media:/var/www/media
    labels:
      - "traefik.enable=true"
      
      # ТОЛЬКО HTTPS - убираем HTTP роутер
      - "traefik.http.routers.dl-blog.rule=Host(`dl-blog.ru`, `www.dl-blog.ru`)"
      - "traefik.http.routers.dl-blog.entrypoints=websecure"
      - "traefik.http.routers.dl-blog.tls.certresolver=letsencrypt"
      
      # Автоматический редирект HTTP → HTTPS (глобально в Traefik)
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      
      # Указываем порт nginx
      - "traefik.http.services.dl-blog.loadbalancer.server.port=80"
    networks:
      - traefik-public
      - app_network
    restart: unless-stopped


  db:
    env_file:
      - ./.env.prod
    restart: unless-stopped

  #pgbackrest:
  #  env_file:
  #    - ./.env.prod

networks:
  traefik-public:
    external: true
